name: Build daily LST PMTiles

on:
  schedule:
    - cron: "0 18 * * *"   # daily at 18:00 UTC
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install GDAL
        run: sudo apt-get update && sudo apt-get install -y gdal-bin

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install rio-pmtiles

      - name: Prepare folders
        run: mkdir -p work tiles        

      # --- Configure your dataset ---
      - name: Build URL for today
        env:
          TARGET_HHMM: "1100"   # adjust if product is published at a different time
        run: |
          Y=$(date -u +%Y)
          M=$(date -u +%m)
          D=$(date -u +%d)
          TS="${Y}${M}${D}${TARGET_HHMM}"
          echo "STAMP=${TS}" >> $GITHUB_ENV
          echo "NETCDF_URL=https://datalsasaf.lsasvcs.ipma.pt/PRODUCTS/MSG/MLST-AS/NETCDF/${Y}/${M}/${D}/NETCDF4_LSASAF_MSG_MLST-AS_MSG-Disk_${TS}.nc" >> $GITHUB_ENV

      - name: Download NetCDF (auth)
        env:
          LSA_USER: ${{ secrets.LSA_USER }}
          LSA_PASS: ${{ secrets.LSA_PASS }}
          NETCDF_URL: ${{ env.NETCDF_URL }}
        run: |
          echo "Fetching: $NETCDF_URL"
          curl -fL -u "${LSA_USER}:${LSA_PASS}" "$NETCDF_URL" -o work/input.nc

      - name: Inspect subdatasets (for logs)
        run: gdalinfo work/input.nc | head -n 100

      - name: NetCDF -> GeoTIFF (native)
        run: |
          gdal_translate "NETCDF:\"work/input.nc\":MLST-AS" work/raw_native.tif -a_nodata 0 -unscale
      
      - name: Diagnose raw_native.tif
        run: |
          echo "=== raw_native.tif ==="
          gdalinfo -mm -stats work/raw_native.tif | sed -n '1,160p'
          gdal_translate -of PNG -scale -ot Byte work/raw_native.tif tiles/raw_native_quicklook.png

      - name: Reproject to EPSG:3857
        run: gdalwarp -t_srs EPSG:3857 -r bilinear -dstalpha work/raw_native.tif work/merc.tif

      - name: Diagnose merc.tif (EPSG:3857)
        run: |
          echo "=== merc.tif ==="
          gdalinfo -mm -stats work/merc.tif | sed -n '1,200p'
          gdal_translate -of PNG -scale -ot Byte work/merc.tif tiles/merc_quicklook.png

      - name: Mask values outside -100 –100 °C
        run: |
          # Anything <0 or >60 becomes NoData (NaN) → transparent later
          gdal_calc.py -A work/merc.tif --outfile=work/merc_masked.tif \
            --calc="where((A>=-100) & (A<=100), A, -9999)" \
            --NoDataValue=-9999 --type=Float32
      
      - name: Diagnose merc_masked.tif (after 0–60 °C mask)
        run: |
          echo "=== merc_masked.tif ==="
          gdalinfo -mm -stats work/merc_masked.tif | sed -n '1,200p'
          gdal_translate -of PNG -scale -ot Byte work/merc_masked.tif tiles/merc_masked_quicklook.png

      - name: Colorize (0–50 °C reverse greyscale)
        run: |
          cat > work/ramp.txt << 'TXT'
          nv 0 0 0 0
          # value(°C)   R   G   B (reverse greyscale)
            0        255 255 255
           60          0   0   0
          TXT
        
          gdaldem color-relief work/merc_masked.tif work/ramp.txt work/color.tif -alpha

      - name: GeoTIFF -> PMTiles
        run: rio pmtiles work/color.tif tiles/raster.pmtiles --zoom-levels 0..6

      - name: Ensure quicklooks exist
        run: |
          test -s tiles/raw_native_quicklook.png
          test -s tiles/merc_quicklook.png
          test -s tiles/merc_masked_quicklook.png
          test -s tiles/raster.pmtiles

      - name: Touch files to ensure they appear changed
        run: touch tiles/raw_native_quicklook.png tiles/raster.pmtiles tiles/merc_quicklook.png tiles/merc_masked_quicklook.png
      
      - name: Commit & push if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "build(pmtiles): MLST-AS daily refresh [skip ci]"
          file_pattern: "tiles/*.png tiles/*.pmtiles"
